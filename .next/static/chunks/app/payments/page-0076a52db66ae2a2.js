(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3074],{6905:function(e,t,a){Promise.resolve().then(a.bind(a,5047))},5047:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return A}});var s=a(7437),r=a(2265),n=a(4033),i=a(6110),c=a(3023),l=a(9155),o=a(2206),d=a(3160),m=a(4045),u=a(5825),h=a(2129),x=a(2601);let f=x.env.PAYSTACK_SECRET_KEY,p=x.env.FLUTTERWAVE_SECRET_KEY,y=async(e,t)=>{try{if("paystack"===e)return await j(t);if("flutterwave"===e)return await v(t);throw Error("Unsupported payment provider")}catch(e){return console.error("Payment initialization error:",e),{data:null,error:e}}},j=async e=>{try{if(!f)throw Error("Paystack secret key not configured");let t=await fetch("https://api.paystack.co/transaction/initialize",{method:"POST",headers:{Authorization:"Bearer ".concat(f),"Content-Type":"application/json"},body:JSON.stringify({email:e.email,amount:e.amount,currency:e.currency||"NGN",reference:e.reference,callback_url:e.callback_url,metadata:e.metadata,channels:["card","bank","ussd","qr","mobile_money","bank_transfer"]})}),a=await t.json();if(!t.ok)throw Error(a.message||"Payment initialization failed");return await N({reference:e.reference,booking_id:e.metadata.booking_id,customer_id:e.metadata.customer_id,amount:e.amount/100,provider:"paystack",status:"pending",payment_data:a.data}),{data:a.data,error:null}}catch(e){return console.error("Paystack initialization error:",e),{data:null,error:e}}},v=async e=>{try{if(!p)throw Error("Flutterwave secret key not configured");let t=await fetch("https://api.flutterwave.com/v3/payments",{method:"POST",headers:{Authorization:"Bearer ".concat(p),"Content-Type":"application/json"},body:JSON.stringify({tx_ref:e.reference,amount:e.amount/100,currency:e.currency||"NGN",redirect_url:e.callback_url,customer:{email:e.email,name:e.metadata.customer_name||"Customer"},customizations:{title:"Bookhushly Payment",description:"Payment for ".concat(e.metadata.service_title),logo:"https://your-logo-url.com/logo.png"},meta:e.metadata})}),a=await t.json();if(!t.ok||"success"!==a.status)throw Error(a.message||"Payment initialization failed");return await N({reference:e.reference,booking_id:e.metadata.booking_id,customer_id:e.metadata.customer_id,amount:e.amount/100,provider:"flutterwave",status:"pending",payment_data:a.data}),{data:{authorization_url:a.data.link},error:null}}catch(e){return console.error("Flutterwave initialization error:",e),{data:null,error:e}}},g=async e=>{try{let t;let{data:a,error:s}=await k(e);if(s||!a)throw Error("Payment record not found");if("paystack"===a.provider)t=await w(e);else if("flutterwave"===a.provider)t=await b(e);else throw Error("Unsupported payment provider");return t.data&&"success"===t.data.status&&await _(e,{status:"completed",verified_at:new Date().toISOString(),verification_data:t.data}),t}catch(e){return console.error("Payment verification error:",e),{data:null,error:e}}},w=async e=>{try{let t=await fetch("https://api.paystack.co/transaction/verify/".concat(e),{method:"GET",headers:{Authorization:"Bearer ".concat(f)}}),a=await t.json();if(!t.ok)throw Error(a.message||"Payment verification failed");return{data:{status:"success"===a.data.status?"success":"failed",amount:a.data.amount/100,reference:a.data.reference,gateway_response:a.data.gateway_response},error:null}}catch(e){return{data:null,error:e}}},b=async e=>{try{let t=await fetch("https://api.flutterwave.com/v3/transactions/verify_by_reference?tx_ref=".concat(e),{method:"GET",headers:{Authorization:"Bearer ".concat(p)}}),a=await t.json();if(!t.ok||"success"!==a.status)throw Error(a.message||"Payment verification failed");return{data:{status:"successful"===a.data.status?"success":"failed",amount:a.data.amount,reference:a.data.tx_ref,gateway_response:a.data.processor_response},error:null}}catch(e){return{data:null,error:e}}},N=async e=>{try{let{data:t,error:a}=await h.O.from("payments").insert({...e,created_at:new Date().toISOString()}).select().single();if(a)throw a;return{data:t,error:null}}catch(e){return console.error("Create payment record error:",e),{data:null,error:e}}},k=async e=>{try{let{data:t,error:a}=await h.O.from("payments").select("*").eq("reference",e).single();if(a)throw a;return{data:t,error:null}}catch(e){return{data:null,error:e}}},_=async(e,t)=>{try{let{data:a,error:s}=await h.O.from("payments").update({...t,updated_at:new Date().toISOString()}).eq("reference",e).select().single();if(s)throw s;return{data:a,error:null}}catch(e){return{data:null,error:e}}},S=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"paystack";return new Promise((a,s)=>{if("paystack"===t){if(window.PaystackPop){let t=window.PaystackPop.setup({key:"pk_test_9c09c55262fece4cb0282d6e5c52f0926b852ded",email:e.email,amount:e.amount,currency:e.currency||"NGN",ref:e.reference,metadata:e.metadata,callback:function(e){a(e)},onClose:function(){s(Error("Payment cancelled"))}});t.openIframe()}else s(Error("Paystack not loaded"))}else"flutterwave"===t&&(window.FlutterwaveCheckout?window.FlutterwaveCheckout({public_key:"FLWPUBK_TEST-your_flutterwave_public_key_here",tx_ref:e.reference,amount:e.amount/100,currency:e.currency||"NGN",customer:{email:e.email,name:e.metadata.customer_name||"Customer"},callback:function(e){a(e)},onclose:function(){s(Error("Payment cancelled"))}}):s(Error("Flutterwave not loaded")))})};var P=a(4530),C=a(9806),T=a(3067),E=a(1738),Z=a(8956),z=a(1271),O=a(9036),B=a(5589),F=a(1396),D=a.n(F),Y=a(1424);function A(){var e,t,a,h,x,f;let{user:p}=(0,m.tN)(),j=(0,n.useRouter)(),v=(0,n.useSearchParams)();console.log("Search Params:",v.toString());let w=v.get("booking");console.log("Booking ID:",w);let b=v.get("reference"),[N,k]=(0,r.useState)(!0),[_,F]=(0,r.useState)(!1),[A,M]=(0,r.useState)(null),[L,G]=(0,r.useState)("pending"),[I,U]=(0,r.useState)("");(0,r.useEffect)(()=>{let e=async()=>{if(!w){U("No booking ID provided"),k(!1);return}try{let{data:e,error:t}=await (0,u.lx)(w);if(t){U("Failed to load booking details");return}M(e),b&&await J(b)}catch(e){U("An unexpected error occurred")}finally{k(!1)}};e()},[w,b]);let J=async e=>{try{let{data:t,error:a}=await g(e);if(a){G("failed"),U("Payment verification failed");return}"success"===t.status?(G("success"),await (0,u.pz)(w,"completed",e),Y.Am.success("Payment successful!",{description:"Your booking has been confirmed"})):(G("failed"),U("Payment was not successful"))}catch(e){G("failed"),U("Payment verification failed")}},R=async e=>{if(A&&p){F(!0),U("");try{var t,a,s,r,n,i,c;let l={email:p.email,amount:100*A.total_amount,currency:"NGN",reference:"BH_".concat(w,"_").concat(Date.now()),callback_url:"".concat(window.location.origin,"/payments?booking=").concat(w),metadata:{booking_id:w,customer_id:p.id,service_title:null===(t=A.listings)||void 0===t?void 0:t.title,customer_name:(null===(a=p.user_metadata)||void 0===a?void 0:a.name)||"Customer"}};try{let t=await S(l,e);if("success"===t.status||"successful"===t.status){let t=await g(l.reference);if((null===(s=t.data)||void 0===s?void 0:s.status)==="success"){await fetch("/api/send-payment-email",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({to:p.email,bookingDetails:{customerName:(null===(r=p.user_metadata)||void 0===r?void 0:r.name)||"Customer",serviceTitle:null===(n=A.listings)||void 0===n?void 0:n.title,amount:A.total_amount.toLocaleString(),reference:l.reference,provider:e,paymentDate:new Date().toLocaleDateString(),bookingUrl:"".concat(window.location.origin,"/dashboard/customer?tab=bookings")}})}),A.contact_phone&&await fetch("/api/send-payment-sms",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:A.contact_phone,data:{serviceTitle:null===(i=A.listings)||void 0===i?void 0:i.title,amount:A.total_amount.toLocaleString(),reference:l.reference}})}),A.contact_phone&&await fetch("/api/send-payment-sms",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:A.contact_phone,data:{serviceTitle:null===(c=A.listings)||void 0===c?void 0:c.title,amount:A.total_amount.toLocaleString(),reference:l.reference}})}),j.push("/payments?booking=".concat(w,"&reference=").concat(l.reference,"&status=success"));return}}}catch(e){console.log("Client-side payment failed, trying server-side:",e)}let{data:o,error:d}=await y(e,l);if(d){U(d.message),Y.Am.error("Payment initialization failed");return}o.authorization_url&&(window.location.href=o.authorization_url)}catch(e){U("Payment initialization failed"),Y.Am.error("Payment failed to initialize")}finally{F(!1)}}};return N?(0,s.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,s.jsx)(d.T,{className:"h-8 w-8"})}):"success"===L?(0,s.jsx)("div",{className:"container max-w-2xl py-8",children:(0,s.jsxs)(i.Zb,{className:"text-center",children:[(0,s.jsxs)(i.Ol,{children:[(0,s.jsx)("div",{className:"mx-auto mb-4 text-green-500",children:(0,s.jsx)(P.Z,{className:"h-16 w-16"})}),(0,s.jsx)(i.ll,{className:"text-2xl text-green-600",children:"Payment Successful!"}),(0,s.jsx)(i.SZ,{children:"Your booking has been confirmed and payment processed"})]}),(0,s.jsxs)(i.aY,{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"bg-green-50 p-4 rounded-lg",children:[(0,s.jsx)("h3",{className:"font-semibold mb-2",children:null==A?void 0:null===(x=A.listings)||void 0===x?void 0:x.title}),(0,s.jsxs)("p",{className:"text-sm text-muted-foreground",children:["Booking Date: ",null==A?void 0:A.booking_date]}),(0,s.jsxs)("p",{className:"text-sm text-muted-foreground",children:["Amount Paid: â‚¦",null==A?void 0:null===(f=A.total_amount)||void 0===f?void 0:f.toLocaleString()]})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)(c.z,{asChild:!0,className:"w-full",children:(0,s.jsx)(D(),{href:"/dashboard/customer?tab=bookings",children:"View My Bookings"})}),(0,s.jsx)(c.z,{variant:"outline",asChild:!0,className:"w-full",children:(0,s.jsx)(D(),{href:"/services",children:"Browse More Services"})})]})]})]})}):"failed"===L?(0,s.jsx)("div",{className:"container max-w-2xl py-8",children:(0,s.jsxs)(i.Zb,{className:"text-center",children:[(0,s.jsxs)(i.Ol,{children:[(0,s.jsx)("div",{className:"mx-auto mb-4 text-red-500",children:(0,s.jsx)(C.Z,{className:"h-16 w-16"})}),(0,s.jsx)(i.ll,{className:"text-2xl text-red-600",children:"Payment Failed"}),(0,s.jsx)(i.SZ,{children:"There was an issue processing your payment"})]}),(0,s.jsxs)(i.aY,{className:"space-y-4",children:[I&&(0,s.jsx)(o.bZ,{variant:"destructive",children:(0,s.jsx)(o.X,{children:I})}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)(c.z,{onClick:()=>G("pending"),className:"w-full",children:"Try Again"}),(0,s.jsx)(c.z,{variant:"outline",asChild:!0,className:"w-full",children:(0,s.jsx)(D(),{href:"/dashboard/customer?tab=bookings",children:"Back to Bookings"})})]})]})]})}):A?(0,s.jsxs)("div",{className:"container max-w-4xl py-8",children:[(0,s.jsx)("div",{className:"mb-6",children:(0,s.jsxs)(D(),{href:"/dashboard/customer?tab=bookings",className:"inline-flex items-center text-sm text-muted-foreground hover:text-foreground",children:[(0,s.jsx)(T.Z,{className:"h-4 w-4 mr-2"}),"Back to Bookings"]})}),(0,s.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[(0,s.jsxs)("div",{className:"lg:col-span-2 space-y-6",children:[(0,s.jsxs)(i.Zb,{children:[(0,s.jsxs)(i.Ol,{children:[(0,s.jsxs)(i.ll,{className:"flex items-center",children:[(0,s.jsx)(E.Z,{className:"mr-2 h-5 w-5"}),"Choose Payment Method"]}),(0,s.jsx)(i.SZ,{children:"Select your preferred payment provider"})]}),(0,s.jsxs)(i.aY,{className:"space-y-4",children:[I&&(0,s.jsx)(o.bZ,{variant:"destructive",children:(0,s.jsx)(o.X,{children:I})}),(0,s.jsx)(i.Zb,{className:"cursor-pointer hover:shadow-md transition-shadow",children:(0,s.jsx)(i.aY,{className:"p-6",children:(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,s.jsx)("div",{className:"w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center",children:(0,s.jsx)(E.Z,{className:"h-6 w-6 text-blue-600"})}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"font-semibold",children:"Paystack"}),(0,s.jsx)("p",{className:"text-sm text-muted-foreground",children:"Card, Bank Transfer, USSD"})]})]}),(0,s.jsx)(c.z,{onClick:()=>R("paystack"),disabled:_,children:_?(0,s.jsx)(d.T,{className:"h-4 w-4"}):"Pay with Paystack"})]})})}),(0,s.jsx)(i.Zb,{className:"cursor-pointer hover:shadow-md transition-shadow",children:(0,s.jsx)(i.aY,{className:"p-6",children:(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,s.jsx)("div",{className:"w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center",children:(0,s.jsx)(Z.Z,{className:"h-6 w-6 text-orange-600"})}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"font-semibold",children:"Flutterwave"}),(0,s.jsx)("p",{className:"text-sm text-muted-foreground",children:"Card, Mobile Money, Bank"})]})]}),(0,s.jsx)(c.z,{variant:"outline",onClick:()=>R("flutterwave"),disabled:_,children:_?(0,s.jsx)(d.T,{className:"h-4 w-4"}):"Pay with Flutterwave"})]})})}),(0,s.jsx)(i.Zb,{className:"cursor-pointer hover:shadow-md transition-shadow opacity-60",children:(0,s.jsx)(i.aY,{className:"p-6",children:(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,s.jsx)("div",{className:"w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center",children:(0,s.jsx)(z.Z,{className:"h-6 w-6 text-green-600"})}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"font-semibold",children:"Mobile Money"}),(0,s.jsx)("p",{className:"text-sm text-muted-foreground",children:"MTN, Airtel, 9mobile"})]})]}),(0,s.jsx)(l.C,{variant:"secondary",children:"Coming Soon"})]})})})]})]}),(0,s.jsxs)(i.Zb,{children:[(0,s.jsx)(i.Ol,{children:(0,s.jsxs)(i.ll,{className:"flex items-center",children:[(0,s.jsx)(O.Z,{className:"mr-2 h-5 w-5 text-green-600"}),"Secure Payment"]})}),(0,s.jsx)(i.aY,{children:(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 text-sm",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,s.jsx)(B.Z,{className:"h-4 w-4 text-green-600"}),(0,s.jsx)("span",{children:"256-bit SSL Encryption"})]}),(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,s.jsx)(O.Z,{className:"h-4 w-4 text-green-600"}),(0,s.jsx)("span",{children:"PCI DSS Compliant"})]}),(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,s.jsx)(P.Z,{className:"h-4 w-4 text-green-600"}),(0,s.jsx)("span",{children:"Verified Merchants"})]})]})})]})]}),(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)(i.Zb,{children:[(0,s.jsx)(i.Ol,{children:(0,s.jsx)(i.ll,{children:"Booking Summary"})}),(0,s.jsxs)(i.aY,{className:"space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"font-semibold",children:null===(e=A.listings)||void 0===e?void 0:e.title}),(0,s.jsxs)("p",{className:"text-sm text-muted-foreground",children:["by ",null===(a=A.listings)||void 0===a?void 0:null===(t=a.vendors)||void 0===t?void 0:t.business_name]})]}),(0,s.jsxs)("div",{className:"space-y-2 text-sm",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{children:"Booking Date:"}),(0,s.jsx)("span",{children:A.booking_date})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{children:"Time:"}),(0,s.jsx)("span",{children:A.booking_time})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{children:"Guests:"}),(0,s.jsx)("span",{children:A.guests})]})]}),(0,s.jsxs)("div",{className:"border-t pt-4 space-y-2",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{children:"Service Fee:"}),(0,s.jsxs)("span",{children:["â‚¦",(A.total_amount/1.05).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,",")]})]}),(0,s.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,s.jsx)("span",{children:"Platform Fee (5%):"}),(0,s.jsxs)("span",{children:["â‚¦",(.05*A.total_amount/1.05).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,",")]})]}),(0,s.jsxs)("div",{className:"flex justify-between font-semibold text-lg border-t pt-2",children:[(0,s.jsx)("span",{children:"Total:"}),(0,s.jsxs)("span",{children:["â‚¦",null===(h=A.total_amount)||void 0===h?void 0:h.toLocaleString()]})]})]})]})]}),(0,s.jsxs)(i.Zb,{children:[(0,s.jsx)(i.Ol,{children:(0,s.jsx)(i.ll,{className:"text-lg",children:"Payment Policy"})}),(0,s.jsxs)(i.aY,{className:"space-y-2 text-sm text-muted-foreground",children:[(0,s.jsx)("p",{children:"â€¢ Payment is processed securely through our partners"}),(0,s.jsx)("p",{children:"â€¢ Refunds available as per vendor cancellation policy"}),(0,s.jsx)("p",{children:"â€¢ Payment confirmation sent via email and SMS"}),(0,s.jsx)("p",{children:"â€¢ 24/7 customer support for payment issues"})]})]})]})]})]}):(0,s.jsx)("div",{className:"container max-w-2xl py-8",children:(0,s.jsx)(i.Zb,{children:(0,s.jsxs)(i.aY,{className:"text-center py-12",children:[(0,s.jsx)(C.Z,{className:"h-12 w-12 text-red-500 mx-auto mb-4"}),(0,s.jsx)("h3",{className:"text-lg font-semibold mb-2",children:"Booking Not Found"}),(0,s.jsx)("p",{className:"text-muted-foreground mb-4",children:"The booking you're trying to pay for could not be found."}),(0,s.jsx)(c.z,{asChild:!0,children:(0,s.jsx)(D(),{href:"/dashboard/customer",children:"Back to Dashboard"})})]})})})}},9155:function(e,t,a){"use strict";a.d(t,{C:function(){return c}});var s=a(7437);a(2265);var r=a(9213),n=a(9311);let i=(0,r.j)("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function c(e){let{className:t,variant:a,...r}=e;return(0,s.jsx)("div",{className:(0,n.cn)(i({variant:a}),t),...r})}}},function(e){e.O(0,[7533,4724,2294,1424,2058,1181,2971,7864,1744],function(){return e(e.s=6905)}),_N_E=e.O()}]);